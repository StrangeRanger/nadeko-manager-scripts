name: Build and Push Multiple Docker Images

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/docker-publish.yml"
      - "Distro Testing/Dockerfile"
      - "Distro Testing/install-deps.bash"
      - "Distro Testing/setup.bash"
      - "m-bridge.bash"
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at 00:00 UTC

permissions:
  contents: read

# Prevent multiple runs from building/pushing at the same time for the same ref (branch). 
# If a new commit lands, cancel the in-progress run and build the newest commit instead.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "ubuntu-24.04"
            base: "ubuntu:24.04"
            pkg: "apt"
          - name: "ubuntu-22.04"
            base: "ubuntu:22.04"
            pkg: "apt"
          - name: "debian-12"
            base: "debian:12"
            pkg: "apt"
          - name: "linuxmint-22"
            base: "linuxmintd/mint22.1-amd64"
            pkg: "apt"
          - name: "linuxmint-21"
            base: "linuxmintd/mint21.3-amd64"
            pkg: "apt"
          - name: "fedora-41"
            base: "fedora:41"
            pkg: "dnf"
          - name: "fedora-40"
            base: "fedora:40"
            pkg: "dnf"
          - name: "almalinux-9"
            base: "almalinux:9"
            pkg: "dnf"
          - name: "almalinux-8"
            base: "almalinux:8"
            pkg: "dnf"
          - name: "rocky-9"
            base: "rockylinux:9"
            pkg: "dnf"
          - name: "rocky-8"
            base: "rockylinux:8"
            pkg: "dnf"
          - name: "opensuse-leap-15.6"
            base: "opensuse/leap:15.6"
            pkg: "zypper"
          - name: "opensuse-tumbleweed"
            base: "opensuse/tumbleweed"
            pkg: "zypper"
          - name: "arch"
            base: "archlinux:latest"
            pkg: "pacman"

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
        with:
          platforms: "linux/arm64,linux/amd64"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build and Push Docker Image for ${{ matrix.name }}
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          push: true
          # Attaches an SBOM attestation (software bill of materials). (Supply-chain metadata)
          sbom: true
          # Attaches a SLSA provenance attestation (how this image was built). (Supply-chain metadata)
          provenance: mode=max
          context: "{{defaultContext}}:Distro Testing"
          file: "Dockerfile"
          build-args: |
            BASE_IMAGE=${{ matrix.base }}
            PKG_MANAGER=${{ matrix.pkg }}
          platforms: ${{ (matrix.name == 'arch' || matrix.name == 'linuxmint-22' || matrix.name == 'linuxmint-21') && 'linux/amd64' || 'linux/amd64,linux/arm64' }}
          tags: ${{ vars.DOCKERHUB_USERNAME }}/nadeko-manager-testing:${{ matrix.name }}
          labels: org.opencontainers.image.source=${{ github.repository }}
          ## The `scope=` keeps amd64 and arm64 caches from colliding with each other.
          cache-from: type=gha,scope=nms-${{ matrix.name }}
          cache-to: type=gha,mode=max,scope=nms-${{ matrix.name }}
